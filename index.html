<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

		<title></title>

		<link href="https://cdn.jsdelivr.net/npm/@mdi/font@5.x/css/materialdesignicons.min.css" rel="stylesheet">
		<link href="https://cdn.jsdelivr.net/npm/vuetify@3.3.2/dist/vuetify.min.css" rel="stylesheet">

		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Monomaniac+One&family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">

		<script src="https://cdn.jsdelivr.net/npm/vue@3.5.11/dist/vue.global.min.js" defer></script>
		<script src="https://cdn.jsdelivr.net/npm/vuetify@3.3.2/dist/vuetify.min.js" defer></script>
		<script src="https://cdn.jsdelivr.net/npm/plotly.js@2.35.2/dist/plotly.min.js" defer></script>
		<script src="script.js" type="module" defer></script>

		<link rev="made" href="mailto:cho45@lowreal.net"/>
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>

		<style>
			.monomaniac-one-regular {
				font-family: "Monomaniac One", sans-serif;
				font-weight: 400;
				font-style: normal;
			}


			// <uniquifier>: Use a unique and descriptive class name
			// <weight>: Use a value from 100 to 900

			.noto-sans-jp-normal {
				font-family: "Noto Sans JP", serif;
				font-optical-sizing: auto;
				font-weight: 600;
				font-style: normal;
			}

			body {
				font-family: "Noto Sans JP", serif;
				font-optical-sizing: auto;
				font-weight: 600;
				font-style: normal;
			}

			.main-view {
				font-family: "Monomaniac One", sans-serif;
				font-weight: 400;
				font-style: normal;
				font-size: 80px;
				text-align: right;
				line-height: 1;
				padding: 20px;
			}

			.main-view .set {
				font-size: 50%;
			}

			#app {
				margin: 0 auto;
			}

			.main-view .unit {
				font-size: 50%;
			}

			.voltage {
				color: oklch(63.11% 0.1964 139.76)
			}

			.current {
				color: oklch(63.11% 0.1964 26.48)
			}

			.voltage.v-chip {
				background: oklch(63.11% 0.1964 139.76);
				color: white;
			}

			.current.v-chip {
				background: oklch(63.11% 0.1964 26.48);
				color: white;
			}

			.v-chip {
				margin-left: 5px;
			}

			.power {
				color: oklch(63.11% 0.1964 230.46)
			}

			.mode {
				font-size: 50%;
			}

			.info {
				font-size: 25%;
			}

			.enabled {
				background: repeating-linear-gradient(-45deg, #ffffff, #ffffff 5px, #fce6ba 5px, #fce6ba 10px);
			}

			.v-btn {
				margin: 10px;
			}


			#numberInputting {
				font-size: 200%;
				text-align: right;
				font-weight: bold;
				padding: 20px 2px;
			}
			
			#numberInput {
				width: 100%;
				table-layout: fixed;
			}

			#numberInput .v-btn {
				margin: 0;
				min-width: auto;
				min-height: 10vh;
				width: 100%;
				box-sizing: border-box;
				background: #efefef;
				font-size: 200%;
				text-transform: none;
			}
		</style>
	</head>
	<body>
		<div id="app">
			<v-toolbar density="default">
				<v-toolbar-title>
					{{ device.modelName }} {{ device.firmwareVersion }} {{ device.hardwareVersion }}
				</v-toolbar-title>

				<v-spacer></v-spacer>

				<span class="ms-2">
					{{ device.temperature.toFixed(0) }}°C
					<span class="input-voltage">Input: {{ formatNumber(device.inputVoltage) }}V</span>
				</span>

				<v-btn class="connect" icon title="Connect" @click="connect" v-if="!port">
					<v-icon>mdi-connection</v-icon>
				</v-btn>
				<v-btn class="disconnect" icon title="Disconnect" @click="disconnect" v-else>
					<v-icon>mdi-connection</v-icon>
				</v-btn>

				<v-btn icon variant="flat" color="green" @click="enable" v-if="!device.outputClosed" title="Enable" :disabled="!port">
					<v-icon>mdi-power</v-icon>
				</v-btn>

				<v-btn icon variant="flat" color="red" @click="disable" v-if="device.outputClosed" title="Disable">
					<v-icon>mdi-power</v-icon>
				</v-btn>

				<v-menu>
					<template v-slot:activator="{ props }">
						<v-btn icon="mdi-dots-vertical" variant="text" v-bind="props"></v-btn>
					</template>

					<v-list>
						<v-list-item>
							<v-list-item-title>test</v-list-item-title>
						</v-list-item>
					</v-list>
				</v-menu>
			</v-toolbar>

			<div class="d-flex">
				<div class="flex-fill" style="padding: 10px;">
					<div ref="graph" stlye="width: 100%; height: 500px"></div>
				</div>

				<div class="main-view" :class="{ enabled: device.outputClosed }" style="width: 300px">
					<div class="voltage" @click="changeVoltage">
						<span>{{ formatNumber(device.outputVoltage) }}</span><span class="unit">V</span>
						<div class="set">
							vset <span>{{ formatNumber(device.setVoltage) }}</span><span class="unit">V</span>
						</div>
					</div>
					<div class="current" @click="changeCurrent">
						<span>{{ formatNumber(device.outputCurrent) }}</span><span class="unit">A</span>
						<div class="set">
							cset <span>{{ formatNumber(device.setCurrent) }}</span><span class="unit">A</span>
						</div>
					</div>
					<div class="power">
						<span>{{ formatNumber(device.outputPower) }}</span><span class="unit">W</span>
					</div>
					<v-chip :class="{ current: device.mode === 'CC', voltage: device.mode === 'CV' }" variant="flat" size="large">
						{{ device.mode }}
					</v-chip>
					<v-chip :color="device.protectionState ? 'red' : 'green' " variant="flat" size="large">
						{{ device.protectionState || "OK" }}
					</v-chip>
				</div>
			</div>

			<div>
				<p>
					metering:
					{{ device.meteringClosed ? 'OFF' : 'ON' }}
				</p>
				<p>
					brightness: {{ device.brightness }}
					volume: {{ device.volume }}
					outputCapacity: {{ device.outputCapacity }}
					outputEnergy: {{ device.outputEnergy }}
				</p>
				<v-table density="compact">
					<template v-if="true">
						<tbody>
							<tr v-for="group in groups">
								<td>{{ group.n }}</td>
								<td>{{ formatNumber(group.setVoltage) }}V</td>
								<td>{{ formatNumber(group.setCurrent) }}A</td>
								<td>
									<v-btn size="x-small" color="green" variant="flat" @click="setGroup(group)">set</v-btn>
								</td>
							</tr>
						</tbody>
					</template>
				</v-table>
			</div>

			<v-table>
				<template v-if="true">
					<tbody>
						<tr>
							<th>OVP</th>
							<td @click="changeOVP">{{ formatNumber(device.overVoltageProtection) }}V</td>
						</tr>
						<tr>
							<th>OCP</th>
							<td>{{ formatNumber(device.overCurrentProtection) }}A</td>
						</tr>
						<tr>
							<th>OPP</th>
							<td>{{ formatNumber(device.overPowerProtection) }}W</td>
						</tr>
						<tr>
							<th>OTP</th>
							<td>{{ formatNumber(device.overTemperatureProtection) }}℃</td>
						</tr>
						<tr>
							<th>LVP</th>
							<td>{{ formatNumber(device.lowVoltageProtection) }}V</td>
						</tr>
					</tbody>
				</template>
			</v-table>

			<v-table v-if="false">
				<template v-if="true">
					<tbody>
						<tr v-for="h in history">
							<td>{{ formatDateTime(h.time) }}</td>
							<td>{{ formatNumber(h.v) }}</td>
							<td>{{ formatNumber(h.i) }}</td>
							<td>{{ formatNumber(h.p) }}</td>
						</tr>
					</tbody>
				</template>
			</v-table>

			<v-btn @click="debug">Debug</v-btn>

			<v-dialog width="auto" v-model="showNumberInput" id="numberInput">
				<v-card :title="numberInput.title" v-if="numberInput">
					<v-divider class="mt-3"></v-divider>
					<v-card-text>

						<div style="height: 100%; width: 100%; display: flex; flex-direction: column">
							<div style="flex: 1">
								<div v-html="numberInput.descriptionHtml" v-if="numberInput.descriptionHtml"></div>
								<div v-else>
									{{ numberInput.description || '' }}
								</div>
							</div>
							<div id="numberInputting">
								<span class="number" v-if="numberInput.input">{{ formatNumberForInput(numberInput.input) }}</span>
								<span class="number" v-else style="color: rgba(0,0,0,.54);">{{ formatNumberForInput(numberInput.prev) }}</span>
								<span class="unit">{{ numberInput.unit }}</span>
							</div>
							<table id="numberInput">
								<tr>
									<td><v-btn variant="tonal" class="" @click="numberInputButton">7</v-btn></td>
									<td><v-btn variant="tonal" class="" @click="numberInputButton">8</v-btn></td>
									<td><v-btn variant="tonal" class="" @click="numberInputButton">9</v-btn></td>
									<td><v-btn variant="tonal" class="" @click="numberInputButton" v-show="numberInput.units[0]">{{ numberInput.units[0] }}</v-btn></td>
								</tr>
								<tr>
									<td><v-btn variant="tonal" class="" @click="numberInputButton">4</v-btn></td>
									<td><v-btn variant="tonal" class="" @click="numberInputButton">5</v-btn></td>
									<td><v-btn variant="tonal" class="" @click="numberInputButton">6</v-btn></td>
									<td><v-btn variant="tonal" class="" @click="numberInputButton" v-show="numberInput.units[1]">{{ numberInput.units[1] }}</v-btn></td>
								</tr>
								<tr>
									<td><v-btn variant="tonal" class="" @click="numberInputButton">1</v-btn></td>
									<td><v-btn variant="tonal" class="" @click="numberInputButton">2</v-btn></td>
									<td><v-btn variant="tonal" class="" @click="numberInputButton">3</v-btn></td>
									<td><v-btn variant="tonal" class="" @click="numberInputButton" v-show="numberInput.units[2]">{{ numberInput.units[2] }}</v-btn></td>
								</tr>
								<tr>
									<td><v-btn variant="tonal" class="" @click="numberInputButton">0</v-btn></td>
									<td><v-btn variant="tonal" class="" @click="numberInputButton">.</v-btn></td>
									<td><v-btn variant="tonal" class="" @click="numberInputButton">&#x232B;</v-btn></td>
									<td><v-btn variant="tonal" class="" @click="numberInputButton" v-show="numberInput.units[3]">{{ numberInput.units[3] }}</v-btn></td>
								</tr>
							</table>
						</div>
					</v-card-text>

					<template v-slot:actions>
						<v-btn
							class="ms-auto"
							text="Cancel"
							@click="showNumberInput = false"
							></v-btn>
					</template>
				</v-card>
			</v-dialog>

			<v-overlay v-model="connectOverlay" class="align-center justify-center" contained>
				<div style="text-align: center">
					<p>Device is not connected</p>
					<p>
						<v-btn @click="connect" v-if="!port">Connect</v-btn>
					</p>
				</div>
			</v-overlay>
		</div>
	</body>
</html>
